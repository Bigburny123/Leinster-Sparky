<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leinster Sparky Quote System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    h2 { margin-top: 0; }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .section {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    label { display: block; margin-top: 10px; font-weight: bold; }
    select, input, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      margin-top: 15px;
    }
    button:hover { opacity: 0.9; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    #totalDisplay {
      font-size: 20px;
      font-weight: bold;
      margin-top: 15px;
    }
    .bottom-buttons {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Leinster Sparky Instant Quote</h2>

  <!-- CUSTOMER DETAILS -->
  <div class="section">
    <label>Full Name</label>
    <input id="custName" type="text">

    <label>Email</label>
    <input id="custEmail" type="email">

    <label>Phone Number</label>
    <input id="custPhone" type="text">

    <label>Eircode</label>
    <input id="custEircode" type="text" placeholder="A91X4E1">

    <label>Property Type</label>
    <select id="custType">
      <option value="House">House</option>
      <option value="Apartment">Apartment</option>
      <option value="Commercial">Commercial</option>
    </select>

    <label>Additional Notes</label>
    <textarea id="custNotes" rows="3"></textarea>
  </div>

  <!-- SERVICE SELECTION -->
  <div class="section">
    <label>Service</label>
    <select id="serviceSelect">
      <option value="Outdoor Socket">Outdoor Socket - €100</option>
      <option value="Socket Installation">Socket Installation - €30</option>
      <option value="Light Fitting">Light Fitting - €25</option>
      <option value="Fuseboard Upgrade">Fuseboard Upgrade - €650</option>
    </select>

    <label>Quantity</label>
    <input id="serviceQty" type="number" value="1" min="1">

    <button onclick="addService()">Add to Quote</button>
  </div>

  <!-- BREAKDOWN TABLE -->
  <table id="breakdownTable" style="display:none;">
    <thead>
      <tr>
        <th>Service</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody id="breakdownBody"></tbody>
  </table>

  <!-- TOTAL PRICE -->
  <div id="totalDisplay">Total: €0</div>

  <!-- BUTTONS -->
  <div class="bottom-buttons">
    <button onclick="resetQuote()" style="background:#dc3545;">Reset</button>
    <button id="sendQuoteBtn">Retrieve My Quote</button>
  </div>
</div>

<!-- EmailJS v3 -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  emailjs.init("rCNjUdb4qChPXsU34");
</script>

<script>
let services = [];
let servicePrices = {
  "Outdoor Socket": 100,
  "Socket Installation": 30,
  "Light Fitting": 25,
  "Fuseboard Upgrade": 650
};

/* ---- Distance calculation for Eircode ---- */
function calculateDistance(eircode) {
  if (!eircode) return 0;

  // Only simple first 3 letters used
  const prefix = eircode.substring(0,3).toUpperCase();
  const distanceMap = {
    "R32": 10, "R35": 12, "R14": 15, "R56": 20,
    "W91": 25, "N91": 30, "R42": 28, "R93": 40,
    "W34": 45, "T23": 120, "D01": 100
  };

  let distance = distanceMap[prefix] !== undefined ? distanceMap[prefix] : 40;
  return distance;
}

function addService() {
  let name = document.getElementById("serviceSelect").value;
  let qty = parseInt(document.getElementById("serviceQty").value);

  services.push({
    name: name,
    qty: qty,
    price: servicePrices[name],
    subtotal: qty * servicePrices[name]
  });

  updateBreakdown();
}

function updateBreakdown() {
  let tbody = document.getElementById("breakdownBody");
  tbody.innerHTML = "";

  let total = 0;
  services.forEach(item => {
    total += item.subtotal;
    tbody.innerHTML += `
      <tr>
        <td>${item.name}</td>
        <td>${item.qty}</td>
        <td>€${item.price}</td>
        <td>€${item.subtotal}</td>
      </tr>
    `;
  });

  // Distance surcharge: first 20km free
  let eircode = document.getElementById("custEircode").value;
  let distanceKm = calculateDistance(eircode);
  let surcharge = 0;

  if (distanceKm > 20) {
    let extraKm = distanceKm - 20;
    let units = Math.ceil(extraKm / 15);
    surcharge = units * 10;
    tbody.innerHTML += `
      <tr>
        <td>Distance Surcharge</td>
        <td>-</td>
        <td>€10 / 15km</td>
        <td>€${surcharge}</td>
      </tr>
    `;
  }

  total += surcharge;

  document.getElementById("breakdownTable").style.display = "table";
  document.getElementById("totalDisplay").innerHTML = `Total: €${total}`;
}

function resetQuote() {
  services = [];
  document.getElementById("breakdownBody").innerHTML = "";
  document.getElementById("breakdownTable").style.display = "none";
  document.getElementById("totalDisplay").innerHTML = "Total: €0";
}

/* ---- SEND QUOTE ---- */
document.getElementById("sendQuoteBtn").addEventListener("click", function() {
  if (services.length === 0) {
    alert("Please add at least one service.");
    return;
  }

  let custName = document.getElementById("custName").value;
  let custEmail = document.getElementById("custEmail").value;
  let custPhone = document.getElementById("custPhone").value;
  let custEircode = document.getElementById("custEircode").value;
  let custType = document.getElementById("custType").value;
  let notes = document.getElementById("custNotes").value;
  let total = document.getElementById("totalDisplay").innerText.replace("Total: €","");

  let rows = document.getElementById("breakdownBody").innerHTML;

  let templateParams = {
    to_name: custName,
    to_email: custEmail,
    owner_email: "ryanbyrne1412@gmail.com",
    items_html: rows,
    total: total,
    phone: custPhone,
    eircode: custEircode,
    property_type: custType,
    notes: notes
  };

  emailjs.send("service_3mekcch", "template_359siqa", templateParams)
    .then(function() {
      alert("Quote sent successfully!");
    }, function(error) {
      console.error("EmailJS Error:", error);
      alert("Failed to send quote. Check console for details.");
    });
});
</script>

</body>
</html>
